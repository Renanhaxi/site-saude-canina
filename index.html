<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Saúde Canina — Saúde & Rotina do Pet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="Organize vacinas, vermífugo, antipulgas, grooming, pesos e histórico. Gere PDF para o veterinário.">
  <meta name="theme-color" content="#0b1220">
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PRELOAD da imagem do herói -->
  <link rel="preload" as="image" href="/assets/hero-shihtzu.jpg"
        imagesrcset="/assets/hero-shihtzu.jpg 1200w"
        imagesizes="(max-width: 768px) 100vw, 520px"
        fetchpriority="high">
  <style>
    :root{
      /* Tema Emerald */
      --brand:#10b981; --brand-600:#059669;
      --ink:#0b1220; --muted:#6b7280; --ring:#e5e7eb;
      --bg:#f7f7fb; --card:#ffffff;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b1220; --card:#111827; --ink:#f3f4f6; --muted:#9ca3af; --ring:#1f2937; }
    }
    html,body{height:100%;}
    body{background:var(--bg); color:var(--ink); -webkit-tap-highlight-color: transparent;}
    .shell{max-width:1024px;margin:0 auto;}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px; box-shadow:0 10px 30px rgba(16,24,40,.08)}
    .btn{padding:.9rem 1rem;border-radius:12px;border:1px solid var(--ring);font-weight:800}
    .btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn-primary:hover{background:var(--brand-600)}
    .btn-light{background:#fff;color:#111827}
    .input{width:100%;border:1px solid var(--ring);border-radius:12px;padding:1rem .95rem;font-size:16px;background:var(--card);color:var(--ink)}
    .label{font-size:.9rem;color:var(--muted)}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:.7rem 1rem;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);opacity:0;transform:translateY(10px);transition:.25s;z-index:50}
    .toast.show{opacity:1;transform:translateY(0)}
    /* HERO */
    .photo-frame{border-radius:20px;padding:2px;background:linear-gradient(135deg,#34d39933,#10b98166);}
    .photo-inner{border-radius:18px;overflow:hidden;background:#0b1220;}
    .photo-img{width:100%;height:100%;object-fit:cover;object-position:center}
  </style>
</head>
<body>

  <!-- Header -->
  <header class="shell px-5 pt-6 pb-4 flex flex-wrap items-center gap-3 justify-between">
    <div class="flex items-center gap-3">
      <svg width="36" height="36" viewBox="0 0 48 48" class="rounded-2xl" aria-label="Logo">
        <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#34d399"/><stop offset="1" stop-color="#10b981"/></linearGradient></defs>
        <rect x="0" y="0" width="48" height="48" rx="12" fill="url(#g)"/>
        <circle cx="16" cy="20" r="4" fill="#fff"/><circle cx="24" cy="16" r="4" fill="#fff"/>
        <circle cx="32" cy="20" r="4" fill="#fff"/><circle cx="24" cy="28" r="8" fill="#fff"/>
      </svg>
      <div>
        <h1 class="text-[22px] md:text-3xl font-black leading-none">Saúde Canina</h1>
        <p class="text-xs text-gray-500 md:text-gray-400">Saúde & Rotina do seu pet</p>
      </div>
      <span class="ml-1 inline-block px-2 py-0.5 rounded-full text-[10px]" style="background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0">MVP</span>
    </div>
    <div id="userBox" class="text-xs text-gray-500"></div>
  </header>

  <!-- HERO (agora usando a sua imagem) -->
  <section class="shell px-5 pb-6">
    <div class="grid lg:grid-cols-2 gap-6 items-center">
      <div>
        <h2 class="text-2xl md:text-4xl font-black leading-tight">
          Tudo do seu Shih Tzu em um só lugar.
        </h2>
        <p class="mt-3 text-gray-600 dark:text-gray-300 max-w-xl">
          Registre vacinas, vermífugo, antipulgas, grooming, pesos e histórico clínico.
          Gere um PDF bonito para o veterinário em um clique.
        </p>
        <div class="mt-5 flex flex-wrap gap-2">
          <span class="px-3 py-1 rounded-full text-sm font-semibold" style="background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0">Lembretes</span>
          <span class="px-3 py-1 rounded-full text-sm font-semibold" style="background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe">PDF</span>
          <span class="px-3 py-1 rounded-full text-sm font-semibold" style="background:#fff7ed;color:#9a3412;border:1px solid #fed7aa">Multi-pets</span>
        </div>
        <div class="mt-6 flex gap-3">
          <a href="#authSection" class="btn btn-primary">Começar agora</a>
          <a href="#tab-pets" class="btn btn-light">Ver recursos</a>
        </div>
      </div>

      <div class="photo-frame">
        <div class="photo-inner">
          <!-- >>> AQUI ESTÁ A SUA IMAGEM <<<
               Suba o arquivo em /assets/hero-shihtzu.jpg ou ajuste o caminho abaixo -->
          <img class="photo-img"
               alt="Dois Shih Tzu no gramado ao entardecer, com a tutora desfocada ao fundo"
               src="/assets/hero-shihtzu.jpg"
               loading="eager" fetchpriority="high" decoding="async"
               style="aspect-ratio:16/9; object-position:center 55%;">
        </div>
      </div>
    </div>
  </section>

  <!-- AUTH -->
  <section id="authSection" class="shell px-5">
    <div class="card p-5">
      <h3 class="text-lg font-bold mb-3">Entrar ou criar conta</h3>
      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <label class="label">E-mail</label>
          <input id="email" class="input" type="email" placeholder="voce@exemplo.com" autocomplete="email" inputmode="email" />
        </div>
        <div>
          <label class="label flex items-center justify-between">
            <span>Senha</span>
            <button id="togglePass" class="text-xs underline text-gray-500" type="button">mostrar</button>
          </label>
          <input id="password" class="input" type="password" placeholder="mín. 6 caracteres" autocomplete="current-password" />
        </div>
      </div>
      <div class="grid sm:grid-cols-2 gap-2 mt-3">
        <button class="btn btn-primary w-full" id="btnSignIn">Entrar</button>
        <button class="btn btn-light w-full" id="btnSignUp">Criar conta</button>
      </div>
      <p id="authMsg" class="text-sm mt-2"></p>
    </div>
  </section>

  <!-- APP -->
  <section id="appSection" class="hidden shell px-5 py-8">
    <div class="card p-4 mb-4 flex flex-wrap gap-2 items-center justify-between">
      <nav class="flex flex-wrap gap-2">
        <button class="btn btn-light" data-tab="dashboard">Dashboard</button>
        <button class="btn btn-light" data-tab="pets">Pets</button>
        <button class="btn btn-light" data-tab="weights">Pesos</button>
        <button class="btn btn-light" data-tab="records">Histórico</button>
        <button class="btn btn-light" data-tab="reminders">Lembretes</button>
      </nav>
      <div class="flex gap-2">
        <button class="btn btn-light" id="btnExportPdf">Exportar PDF</button>
        <button class="btn btn-primary" id="btnSignOut">Sair</button>
      </div>
    </div>

    <div id="tab-dashboard" class="card p-4 mb-4">
      <div class="flex items-center justify-between gap-2">
        <div>
          <h2 class="text-base font-bold">Resumo</h2>
          <p id="dashInfo" class="text-sm text-gray-600 dark:text-gray-300"></p>
        </div>
        <button id="btnApplyShihTzu" class="btn btn-primary">Rotina Shih Tzu</button>
      </div>
    </div>

    <div id="tab-pets" class="card p-4 mb-4 hidden">
      <h2 class="text-base font-bold mb-2">Pets</h2>
      <div class="grid md:grid-cols-4 gap-3">
        <input id="petName" class="input" placeholder="Nome" />
        <input id="petBreed" class="input" placeholder="Raça (ex.: Shih Tzu)" />
        <input id="petBirth" class="input" type="date" />
        <select id="petSex" class="input"><option value="">Sexo</option><option value="F">Fêmea</option><option value="M">Macho</option></select>
      </div>
      <div class="flex gap-2 mt-3">
        <button class="btn btn-primary" id="btnAddPet">Adicionar</button>
        <button class="btn btn-light" id="btnReloadPets">Recarregar</button>
      </div>
      <div class="mt-3 overflow-auto">
        <table class="w-full text-sm">
          <thead class="text-left text-gray-500 border-b">
            <tr><th class="py-2">Sel.</th><th>Nome</th><th>Raça</th><th>Nasc.</th><th class="text-right">Ações</th></tr>
          </thead>
          <tbody id="petsTable"></tbody>
        </table>
      </div>
    </div>

    <div id="tab-weights" class="card p-4 mb-4 hidden">
      <h2 class="text-base font-bold mb-2">Pesagens</h2>
      <div class="grid md:grid-cols-3 gap-3">
        <input id="wDate" class="input" type="date" />
        <input id="wKg" class="input" type="number" step="0.001" placeholder="Peso (kg)" inputmode="decimal" />
        <button class="btn btn-primary" id="btnAddWeight">Adicionar peso</button>
      </div>
      <div class="mt-3 overflow-auto">
        <table class="w-full text-sm">
          <thead class="text-left text-gray-500 border-b">
            <tr><th class="py-2">Data</th><th>Peso (kg)</th></tr>
          </thead>
          <tbody id="weightsTable"></tbody>
        </table>
      </div>
    </div>

    <div id="tab-records" class="card p-4 mb-4 hidden">
      <h2 class="text-base font-bold mb-2">Histórico</h2>
      <div class="grid md:grid-cols-4 gap-3">
        <select id="recKind" class="input">
          <option value="vaccine">Vacina</option><option value="deworm">Vermífugo</option>
          <option value="flea">Antipulgas</option><option value="groom">Grooming/Tosa</option>
          <option value="med">Medicação</option><option value="exam">Exame</option><option value="note">Nota</option>
        </select>
        <input id="recTitle" class="input" placeholder="Título (ex.: V10 dose 1)" />
        <input id="recDate" class="input" type="date" />
        <input id="recNotes" class="input" placeholder="Obs. (lote, clínica...)" />
      </div>
      <button class="btn btn-primary mt-3" id="btnAddRecord">Adicionar</button>
      <div class="mt-3 overflow-auto">
        <table class="w-full text-sm">
          <thead class="text-left text-gray-500 border-b">
            <tr><th class="py-2">Data</th><th>Tipo</th><th>Título</th><th>Obs.</th></tr>
          </thead>
          <tbody id="recordsTable"></tbody>
        </table>
      </div>
    </div>

    <div id="tab-reminders" class="card p-4 mb-4 hidden">
      <h2 class="text-base font-bold mb-2">Lembretes</h2>
      <div class="grid md:grid-cols-4 gap-3">
        <select id="remKind" class="input">
          <option value="vaccine">Vacina</option><option value="deworm">Vermífugo</option>
          <option value="flea">Antipulgas</option><option value="groom">Grooming/Tosa</option>
          <option value="med">Medicação</option><option value="custom">Personalizado</option>
        </select>
        <input id="remTitle" class="input" placeholder="Título (ex.: Reforço V10)" />
        <input id="remDateTime" class="input" type="datetime-local" />
        <select id="remPeriod" class="input">
          <option value="">Único</option><option value="P30D">Mensal (30d)</option>
          <option value="P3M">Trimestral (3m)</option><option value="P6M">Semestral (6m)</option><option value="P1Y">Anual (1a)</option>
        </select>
      </div>
      <button class="btn btn-primary mt-3" id="btnAddReminder">Criar lembrete</button>
      <div class="mt-3 overflow-auto">
        <table class="w-full text-sm">
          <thead class="text-left text-gray-500 border-b">
            <tr><th class="py-2">Data/Hora</th><th>Título</th><th>Tipo</th><th>Ativo</th></tr>
          </thead>
          <tbody id="remindersTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <footer class="shell px-5 pb-10 text-xs text-gray-500">
    © Saúde Canina. Este site não substitui avaliação veterinária. Em emergências, procure um profissional.
  </footer>

  <div id="toast" class="toast">ok</div>

  <!-- APP (ESM): Supabase importado como módulo -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    const TZ = "America/Belem";
    const SUPABASE_URL = "https://gclcyagmerselwbjwftl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjbGN5YWdtZXJzZWx3Ymp3ZnRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5NzIyMTQsImV4cCI6MjA3NzU0ODIxNH0.T8IY09MnDJcCv3kp756iwnRgbShRQaeRnvRK8pVbLeQ";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:true, autoRefreshToken:true } });

    let currentUser=null, selectedPet=null;
    const $ = (id)=>document.getElementById(id);
    const fmtDate = (d)=> new Date(d).toLocaleDateString('pt-BR',{ timeZone:TZ });
    const fmtDateTime = (d)=> new Date(d).toLocaleString('pt-BR',{ timeZone:TZ });
    const toast=(m,ok=true)=>{const t=$('toast');t.textContent=m;t.style.background=ok?'#111827':'#991b1b';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200);};
    const setAuthMsg=(t,ok=false)=>{const el=$('authMsg');el.textContent=t||'';el.className='text-sm mt-2 '+(ok?'text-green-700':'text-red-600');};

    function activateTab(name){ ['dashboard','pets','weights','records','reminders'].forEach(t=>{ const el=$('tab-'+t); if(el) el.classList.toggle('hidden', t!==name); }); }

    async function ensureProfile(){
      if(!currentUser) return;
      const { data:p } = await sb.from('profiles').select('id').eq('id', currentUser.id).maybeSingle();
      if(!p){ await sb.from('profiles').insert({ id: currentUser.id, full_name:(currentUser.email||'').split('@')[0] }); }
    }
    async function onLoggedIn(){
      $('authSection').classList.add('hidden');
      $('appSection').classList.remove('hidden');
      $('userBox').innerHTML = `<span class="text-xs">Conectado • ${currentUser.email}</span>`;
      activateTab('dashboard'); await refreshAll();
    }
    async function refreshAll(){
      await Promise.all([loadPets(), loadWeights(), loadRecords(), loadReminders()]);
      const petsCount = (await sb.from('pets').select('id',{count:'exact', head:true})).count || 0;
      const remCount  = (await sb.from('reminders').select('id',{count:'exact', head:true})).count || 0;
      $('dashInfo').textContent = `Você tem ${petsCount} pet(s) e ${remCount} lembrete(s).`;
    }

    async function loadPets(){
      const { data, error } = await sb.from('pets').select('*').order('created_at',{ascending:false});
      if(error){ toast(error.message,false); return; }
      const tbody=$('petsTable'); if(!tbody) return;
      tbody.innerHTML='';
      (data||[]).forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td class="py-2"><input type="radio" name="petSelect"></td><td>${p.name}</td><td>${p.breed||''}</td><td>${p.birth_date?fmtDate(p.birth_date):''}</td><td class="text-right"><button class="text-red-600 underline text-xs" data-del="${p.id}">remover</button></td>`;
        tr.querySelector('input').onclick=()=>{ selectedPet=p; toast('Pet selecionado: '+p.name); };
        tr.querySelector('[data-del]').onclick=async()=>{ if(confirm('Remover este pet e seus dados?')){ await sb.from('pets').delete().eq('id', p.id); if(selectedPet?.id===p.id) selectedPet=null; await refreshAll(); } };
        tbody.appendChild(tr);
      });
    }
    async function loadWeights(){
      const tbody=$('weightsTable'); if(!tbody) return;
      if(!selectedPet){ tbody.innerHTML='<tr><td class="py-2 text-gray-500" colspan="2">Selecione um pet.</td></tr>'; return; }
      const { data, error } = await sb.from('weights').select('*').eq('pet_id', selectedPet.id).order('at_date',{ascending:false});
      if(error){ toast(error.message,false); return; }
      tbody.innerHTML=''; (data||[]).forEach(w=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class="py-2">${fmtDate(w.at_date)}</td><td>${Number(w.weight_kg).toFixed(3)}</td>`; tbody.appendChild(tr); });
    }
    async function loadRecords(){
      const tbody=$('recordsTable'); if(!tbody) return;
      if(!selectedPet){ tbody.innerHTML='<tr><td class="py-2 text-gray-500" colspan="4">Selecione um pet.</td></tr>'; return; }
      const { data, error } = await sb.from('records').select('*').eq('pet_id', selectedPet.id).order('at_date',{ascending:false});
      if(error){ toast(error.message,false); return; }
      tbody.innerHTML=''; (data||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class="py-2">${fmtDate(r.at_date)}</td><td>${r.kind}</td><td>${r.title||''}</td><td>${r.notes||''}</td>`; tbody.appendChild(tr); });
    }
    async function loadReminders(){
      const tbody=$('remindersTable'); if(!tbody) return;
      const petIds=(await sb.from('pets').select('id')).data?.map(p=>p.id)||[];
      if(petIds.length===0){ tbody.innerHTML='<tr><td class="py-2 text-gray-500" colspan="4">Cadastre um pet.</td></tr>'; return; }
      const { data, error } = await sb.from('reminders').select('*').in('pet_id', petIds).order('due_at');
      if(error){ toast(error.message,false); return; }
      tbody.innerHTML=''; (data||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class="py-2">${fmtDateTime(r.due_at)}</td><td>${r.title||''}</td><td>${r.kind}</td><td>${r.active?'Sim':'Não'}</td>`; tbody.appendChild(tr); });
    }

    // UI binds
    document.getElementById('togglePass').addEventListener('click', ()=>{
      const p=$('password'); const is=p.type==='password'; p.type=is?'text':'password';
      document.getElementById('togglePass').textContent=is?'ocultar':'mostrar';
    });

    document.getElementById('btnSignIn').addEventListener('click', async ()=>{
      setAuthMsg('');
      const email=$('email').value.trim(), password=$('password').value.trim();
      if(!email||!password){ setAuthMsg('Informe e-mail e senha.'); return; }
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if(error){ setAuthMsg(error.message); return; }
      currentUser=data.user; await ensureProfile(); await onLoggedIn();
    });

    document.getElementById('btnSignUp').addEventListener('click', async ()=>{
      setAuthMsg('');
      const email=$('email').value.trim(), password=$('password').value.trim();
      if(!email||!password){ setAuthMsg('Informe e-mail e senha.'); return; }
      const { data, error } = await sb.auth.signUp({ email, password });
      if(error){ setAuthMsg(error.message); return; }
      if(data.session){ currentUser=data.user; await ensureProfile(); await onLoggedIn(); return; }
      const si = await sb.auth.signInWithPassword({ email, password });
      if(si.error){ setAuthMsg('No Supabase, desligue "Confirmar e-mail" para login direto.'); return; }
      currentUser=si.data.user; await ensureProfile(); await onLoggedIn();
    });

    document.getElementById('btnSignOut').addEventListener('click', async ()=>{
      await sb.auth.signOut(); currentUser=null; selectedPet=null;
      $('userBox').innerHTML=''; $('authSection').classList.remove('hidden'); $('appSection').classList.add('hidden');
    });

    document.querySelectorAll('[data-tab]').forEach(b=>b.addEventListener('click',()=>activateTab(b.dataset.tab)));

    document.getElementById('btnAddPet').addEventListener('click', async ()=>{
      if(!currentUser){ toast('Faça login primeiro', false); return; }
      const body={ owner_id: currentUser.id, name:$('petName').value.trim(), breed:$('petBreed').value.trim(), birth_date:$('petBirth').value||null, sex:$('petSex').value||null };
      if(!body.name){ toast('Informe o nome', false); return; }
      const { error } = await sb.from('pets').insert(body);
      if(error){ toast(error.message,false); return; }
      $('petName').value='';$('petBreed').value='';$('petBirth').value='';$('petSex').value='';
      await loadPets(); toast('Pet adicionado!');
    });
    document.getElementById('btnReloadPets').addEventListener('click', loadPets);

    document.getElementById('btnAddWeight').addEventListener('click', async ()=>{
      if(!selectedPet){ toast('Selecione um pet', false); return; }
      const at=$('wDate').value||new Date().toISOString().slice(0,10), kg=parseFloat($('wKg').value||'0');
      if(!kg){ toast('Informe o peso (kg)', false); return; }
      const { error } = await sb.from('weights').insert({ pet_id:selectedPet.id, at_date:at, weight_kg:kg });
      if(error){ toast(error.message,false); return; }
      $('wDate').value='';$('wKg').value=''; await loadWeights(); toast('Peso adicionado!');
    });

    document.getElementById('btnAddRecord').addEventListener('click', async ()=>{
      if(!selectedPet){ toast('Selecione um pet', false); return; }
      const body={ pet_id:selectedPet.id, kind:$('recKind').value, title:$('recTitle').value.trim()||null, at_date:$('recDate').value||new Date().toISOString().slice(0,10), notes:$('recNotes').value.trim()||null };
      const { error } = await sb.from('records').insert(body);
      if(error){ toast(error.message,false); return; }
      $('recTitle').value='';$('recDate').value='';$('recNotes').value=''; await loadRecords(); toast('Registro adicionado!');
    });

    document.getElementById('btnAddReminder').addEventListener('click', async ()=>{
      if(!selectedPet){ toast('Selecione um pet', false); return; }
      const due=$('remDateTime').value? new Date($('remDateTime').value): new Date();
      const body={ pet_id:selectedPet.id, kind:$('remKind').value, title:$('remTitle').value.trim()||'Lembrete', due_at:due.toISOString(), periodicity:$('remPeriod').value||null, active:true };
      const { error } = await sb.from('reminders').insert(body);
      if(error){ toast(error.message,false); return; }
      $('remTitle').value='';$('remDateTime').value='';$('remPeriod').value=''; await loadReminders(); toast('Lembrete criado!');
    });

    document.getElementById('btnApplyShihTzu').addEventListener('click', async ()=>{
      if(!selectedPet){ toast('Selecione um pet', false); return; }
      const base=new Date(), add=(d,t,k,p)=>({pet_id:selectedPet.id,title:t,kind:k,due_at:new Date(base.getTime()+d*86400000).toISOString(),periodicity:p||null,active:true});
      const items=[ add(0,'Limpeza de olhos','groom','P7D'), add(0,'Higiene auricular','groom','P14D'),
                    add(3,'Antipulgas','flea','P30D'), add(10,'Vermífugo (reforço)','deworm','P3M'),
                    add(20,'Tosa higiênica','groom','P30D'), add(30,'Revisão clínica','note','P6M'),
                    add(40,'Vacina anual','vaccine','P1Y') ];
      const { error } = await sb.from('reminders').insert(items);
      if(error){ toast(error.message,false); return; }
      await loadReminders(); toast('Rotina Shih Tzu aplicada!');
    });

    document.getElementById('btnExportPdf').addEventListener('click', async ()=>{
      const { jsPDF } = await import('https://esm.sh/jspdf@2.5.1');
      const doc = new jsPDF();
      doc.text("Relatório do Pet — Saúde Canina", 14, 16);
      doc.text("Gere aqui seu relatório real usando os dados do Supabase.", 14, 26);
      doc.save("relatorio-pet.pdf");
    });

    // Restaura sessão
    const { data } = await sb.auth.getSession();
    if(data.session){ currentUser=data.session.user; await onLoggedIn(); }
    sb.auth.onAuthStateChange((ev, session)=>{
      if(session && (ev==='SIGNED_IN'||ev==='TOKEN_REFRESHED')){ currentUser=session.user; ensureProfile().then(onLoggedIn); }
    });
  </script>
</body>
</html>
